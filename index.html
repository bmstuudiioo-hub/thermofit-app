<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ThermoFit App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA: Manifest -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- PWA: Colores y tema -->
  <meta name="theme-color" content="#020617">
  <meta name="description" content="ThermoFit ‚Äì Camiseta inteligente con control t√©rmico y monitorizaci√≥n fisiol√≥gica.">

  <!-- PWA: Iconos (aseg√∫rate de tenerlos en /icons) -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">

  <style>
    :root {
      --bg: #050816;
      --bg-soft: #0f172a;
      --card: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-danger: #ef4444;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: #1f2937;
      --radius-lg: 18px;
      --radius-xl: 28px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827, #020617);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app-container {
      width: 100%;
      max-width: 450px;
      min-height: 100vh;
      padding: 16px 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Pantallas */
    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
      gap: 14px;
    }
    .screen.active {
      display: flex;
    }

    /* HEADER GENERAL (solo en main) */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 4px 4px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: conic-gradient(from 180deg, #22c55e, #0ea5e9, #22c55e);
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .brand-logo-inner {
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: #22c55e;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-text h1 {
      font-size: 18px;
      letter-spacing: 0.04em;
    }

    .brand-text span {
      font-size: 11px;
      color: var(--muted);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
    }

    .chip-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    .chip-dot.offline {
      background: #6b7280;
      box-shadow: none;
    }

    .icon-btn {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.8);
      font-size: 15px;
      cursor: pointer;
    }

    .avatar-circle {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      background-size: cover;
      background-position: center;
      display: none;
    }
    .avatar-circle.has-photo {
      display: block;
    }

    /* Tarjetas y layout general de main */
    main {
      display: flex;
      flex-direction: column;
      gap: 14px;
      flex: 1;
    }

    .cards-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .card {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #111827, #020617);
      border: 1px solid var(--border);
      padding: 12px 12px 10px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.8);
      position: relative;
      overflow: hidden;
    }

    .card-title {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .card-main {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .metric-unit {
      font-size: 13px;
      color: var(--muted);
      margin-left: 3px;
    }

    .metric-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .card-large {
      border-radius: var(--radius-xl);
      padding: 14px 14px 12px;
      background: radial-gradient(circle at top, #0f172a, #020617);
    }

    .chip-mode {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .heat-level-row {
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .heat-level-text {
      font-size: 30px;
      font-weight: 600;
    }

    .badge-soft {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .slider-row {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      height: 5px;
      border-radius: 999px;
      background: #1f2937;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
      cursor: pointer;
      border: 2px solid #020617;
    }

    .mode-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border);
      overflow: hidden;
      margin-top: 8px;
    }

    .mode-btn {
      font-size: 11px;
      padding: 5px 10px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .mode-btn.active {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .bottom-section {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 10px;
    }

    .alert-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    .alert-title {
      font-size: 12px;
      margin-bottom: 4px;
      font-weight: 500;
    }

    .alert-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(248, 113, 113, 0.5);
      color: #fecaca;
      background: rgba(127, 29, 29, 0.4);
    }

    .alert-tag-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #f87171;
    }

    .history-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
      color: var(--muted);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
    }

    footer {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(31, 41, 55, 0.7);
    }

    .nav {
      display: flex;
      justify-content: space-around;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
    }

    .nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
    }

    .nav-btn span:first-child {
      font-size: 16px;
    }

    .nav-btn.active {
      color: var(--accent);
      background: rgba(34, 197, 94, 0.1);
    }

    .hint {
      font-size: 9px;
      text-align: center;
      color: var(--muted);
      margin-top: 6px;
      opacity: 0.7;
    }

    @media (max-width: 370px) {
      .cards-row {
        grid-template-columns: 1fr;
      }
      .bottom-section {
        grid-template-columns: 1fr;
      }
    }

    /* Formularios (login, perfil, selecci√≥n, comunidad) */
    .screen-header {
      margin-top: 12px;
      margin-bottom: 8px;
    }

    .screen-header-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .screen-header-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .form-card {
      border-radius: var(--radius-xl);
      background: radial-gradient(circle at top, #0f172a, #020617);
      border: 1px solid var(--border);
      padding: 16px 14px 14px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
    }

    .field label {
      color: var(--muted);
    }

    .field input,
    .field select {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text);
      outline: none;
    }

    .field input::placeholder {
      color: #6b7280;
    }

    .btn-primary {
      margin-top: 4px;
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 500;
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: #020617;
      cursor: pointer;
    }

    .btn-secondary {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 14px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.8);
      color: var(--muted);
      cursor: pointer;
    }

    .device-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .device-item {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: radial-gradient(circle at top left, #020617, #020617);
      font-size: 12px;
    }

    .device-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .badge-soft-small {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .hello-user {
      font-size: 11px;
      color: var(--muted);
    }

    .activity-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: -4px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--muted);
    }

    .activity-select {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      padding: 4px 8px;
      font-size: 11px;
      color: var(--text);
      outline: none;
    }

    .back-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .btn-back-inline {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 5px 10px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .profile-photo-preview {
      width: 70px;
      height: 70px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      background: rgba(15, 23, 42, 0.9);
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .profile-photo-preview.has-photo {
      border-style: solid;
      color: transparent;
    }

    .community-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .community-card {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 10px 10px;
      background: radial-gradient(circle at top left, #111827, #020617);
      display: flex;
      gap: 10px;
      font-size: 12px;
    }

    .community-avatar {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: var(--accent);
    }

    .community-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .community-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
    }

    .community-main {
      font-size: 11px;
      color: var(--muted);
    }

    .tag {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid var(--border);
    }

  </style>
</head>
<body>
  <div class="app-container">
    <!-- PANTALLA 1: LOGIN -->
    <section id="screen-login" class="screen active">
      <div class="screen-header">
        <div class="screen-header-title">Bienvenido a ThermoFit</div>
        <div class="screen-header-sub">
          Inicia sesi√≥n para guardar tu perfil y tus sesiones de entrenamiento.
        </div>
      </div>

      <div class="form-card">
        <div class="field">
          <label for="login-name">Nombre</label>
          <input id="login-name" type="text" placeholder="Ej. Alex" />
        </div>
        <div class="field">
          <label for="login-email">Email</label>
          <input id="login-email" type="email" placeholder="tucorreo@ejemplo.com" />
        </div>
        <button class="btn-primary" id="btn-login-next">Continuar</button>
        <p class="hint">
          En esta demo los datos se guardan solo en este dispositivo (localStorage).
        </p>
      </div>
    </section>

    <!-- PANTALLA 2: PERFIL -->
    <section id="screen-profile" class="screen">
      <div class="back-row">
        <button class="btn-back-inline" id="btn-profile-back">
          ‚Üê Volver
        </button>
      </div>
      <div class="screen-header">
        <div class="screen-header-title">Tu perfil</div>
        <div class="screen-header-sub">
          Ajusta tu experiencia: ThermoFit adaptar√° las alertas y el calor a tu contexto.
        </div>
      </div>
      <div class="form-card">
        <div class="field">
          <label for="profile-age">Edad</label>
          <input id="profile-age" type="number" min="10" max="100" placeholder="Ej. 24" />
        </div>
        <div class="field">
          <label for="profile-weight">Peso (kg)</label>
          <input id="profile-weight" type="number" min="30" max="200" placeholder="Ej. 70" />
        </div>
        <div class="field">
          <label for="profile-goal">Objetivo principal</label>
          <select id="profile-goal">
            <option value="salud">Salud y bienestar</option>
            <option value="rendimiento">Rendimiento deportivo</option>
            <option value="trabajo-frio">Trabajo en fr√≠o / exterior</option>
          </select>
        </div>
        <div class="field">
          <label for="profile-photo">Foto de perfil</label>
          <input id="profile-photo" type="file" accept="image/*" />
          <div class="profile-photo-preview" id="profile-photo-preview">
            Vista previa
          </div>
        </div>
        <button class="btn-primary" id="btn-profile-next">Guardar y continuar</button>
      </div>
    </section>

    <!-- PANTALLA 3: SELECCI√ìN DE CAMISETA -->
    <section id="screen-device" class="screen">
      <div class="back-row">
        <button class="btn-back-inline" id="btn-device-back">
          ‚Üê Volver
        </button>
      </div>
      <div class="screen-header">
        <div class="screen-header-title">Selecciona tu ThermoFit</div>
        <div class="screen-header-sub">
          En la versi√≥n real, aqu√≠ aparecer√≠an los dispositivos Bluetooth cercanos.
        </div>
      </div>
      <div class="form-card">
        <div class="device-list">
          <div class="device-item">
            <div class="device-meta">
              <strong>ThermoFit-001</strong>
              <span class="hello-user">Prototipo de laboratorio</span>
            </div>
            <button class="btn-secondary btn-device" data-device-id="ThermoFit-001">
              Conectar
            </button>
          </div>
          <div class="device-item">
            <div class="device-meta">
              <strong>ThermoFit-002</strong>
              <span class="hello-user">Versi√≥n deporte</span>
            </div>
            <button class="btn-secondary btn-device" data-device-id="ThermoFit-002">
              Conectar
            </button>
          </div>
          <div class="device-item">
            <div class="device-meta">
              <strong>ThermoFit-003</strong>
              <span class="hello-user">Uso exterior / fr√≠o</span>
            </div>
            <button class="btn-secondary btn-device" data-device-id="ThermoFit-003">
              Conectar
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- PANTALLA 4: APP PRINCIPAL -->
    <section id="screen-main" class="screen">
      <!-- HEADER -->
      <header>
        <div class="brand">
          <div class="brand-logo">
            <div class="brand-logo-inner">T</div>
          </div>
          <div class="brand-text">
            <h1>ThermoFit</h1>
            <span id="user-subtitle">Smart Performance Wear</span>
          </div>
        </div>
        <div class="header-actions">
          <div class="avatar-circle" id="avatar-circle"></div>
          <div class="chip" id="chip-connection">
            <span class="chip-dot offline" id="conn-dot"></span>
            <span id="conn-text">Sin conectar</span>
          </div>
          <button class="icon-btn" id="btn-connect" title="Conectar camiseta">
            üîó
          </button>
        </div>
      </header>

      <!-- ACTIVIDAD ACTUAL -->
      <div class="activity-row">
        <span id="hello-user-text" class="hello-user">Hola üëã</span>
        <div>
          <span style="margin-right:4px;">Actividad:</span>
          <select id="activity-select" class="activity-select">
            <option value="reposo">Reposo</option>
            <option value="deporte">Deporte</option>
            <option value="trabajo-frio">Trabajo en fr√≠o</option>
          </select>
        </div>
      </div>

      <!-- CONTENIDO PRINCIPAL -->
      <main>
        <!-- M√©tricas principales -->
        <section class="cards-row">
          <!-- Frecuencia cardiaca -->
          <article class="card" id="card-hr">
            <div class="card-title">
              <span>Frecuencia card√≠aca</span>
              <span class="pill">
                <span class="pill-dot"></span>
                En rango
              </span>
            </div>
            <div class="card-main">
              <div>
                <span class="metric-value" id="hr-value">--</span>
                <span class="metric-unit">bpm</span>
              </div>
              <div class="metric-sub" id="hr-status">Esperando datos...</div>
            </div>
          </article>

          <!-- Temperatura corporal -->
          <article class="card" id="card-temp">
            <div class="card-title">
              <span>Temperatura corporal</span>
              <span style="font-size: 11px; color: var(--muted);" id="temp-zones-label">
                Pecho / Espalda / Axila
              </span>
            </div>
            <div class="card-main">
              <div>
                <span class="metric-value" id="temp-main">--</span>
                <span class="metric-unit">¬∞C</span>
              </div>
              <div class="metric-sub" id="temp-sub">
                T. media ‚Äî esperando datos...
              </div>
            </div>
          </article>
        </section>

        <!-- Control t√©rmico -->
        <section class="card card-large">
          <div class="card-title">
            <span>Control t√©rmico</span>
            <span class="chip-mode" id="mode-chip">
              <span class="chip-dot"></span>
              Modo autom√°tico
            </span>
          </div>

          <div class="heat-level-row">
            <div>
              <span class="heat-level-text" id="heat-level-text">0%</span>
            </div>
            <span class="badge-soft" id="heat-desc">
              Calefacci√≥n desactivada
            </span>
          </div>

          <div class="slider-row">
            <label for="heat-slider">Nivel de calor (modo manual)</label>
            <input type="range" min="0" max="100" value="0" id="heat-slider" />
          </div>

          <div class="mode-toggle">
            <button class="mode-btn active" id="btn-mode-auto">Auto</button>
            <button class="mode-btn" id="btn-mode-manual">Manual</button>
          </div>
        </section>

        <!-- Alertas + Historial -->
        <section class="bottom-section">
          <article class="card">
            <div class="card-title">
              <span>Alertas</span>
            </div>
            <div class="card-main" id="alerts-container">
              <div class="alert-item">
                <div class="alert-title">Sin alertas cr√≠ticas</div>
                <div class="metric-sub">
                  Todo estable. Mant√©n la conexi√≥n activa para monitorizar cambios.
                </div>
              </div>
            </div>
          </article>

          <article class="card">
            <div class="card-title">
              <span>Historial (hoy)</span>
            </div>
            <div class="card-main">
              <div class="history-list" id="history-list">
                <div class="history-item">
                  <span>Inicio sesi√≥n</span>
                  <span>‚Äî:‚Äî</span>
                </div>
                <div class="history-item">
                  <span>Nivel medio calor</span>
                  <span>0%</span>
                </div>
                <div class="history-item">
                  <span>Alertas</span>
                  <span>0</span>
                </div>
              </div>
            </div>
          </article>
        </section>
      </main>

      <!-- NAV / FOOTER -->
      <footer>
        <nav class="nav">
          <div class="nav-btn active" id="nav-panel">
            <span>üìä</span>
            <span>Panel</span>
          </div>
          <div class="nav-btn" id="nav-community">
            <span>üî•</span>
            <span>Comunidad</span>
          </div>
          <div class="nav-btn" id="nav-history">
            <span>üßæ</span>
            <span>Historial</span>
          </div>
          <div class="nav-btn" id="nav-settings">
            <span>‚öôÔ∏è</span>
            <span>Ajustes</span>
          </div>
        </nav>
        <div class="hint">
          Demo PWA: los datos se simulan. En el futuro aqu√≠ se conectar√° por Bluetooth a la camiseta ThermoFit.
        </div>
      </footer>
    </section>

    <!-- PANTALLA 5: SESIONES DE LA COMUNIDAD -->
    <section id="screen-community" class="screen">
      <div class="back-row">
        <button class="btn-back-inline" id="btn-community-back">
          ‚Üê Volver al panel
        </button>
      </div>
      <div class="screen-header">
        <div class="screen-header-title">Sesiones de la comunidad</div>
        <div class="screen-header-sub">
          Insp√≠rate viendo c√≥mo usan otros su ThermoFit.
        </div>
      </div>
      <div class="form-card">
        <div class="community-list" id="community-list">
          <!-- Rellenado por JS -->
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------------------------
    // GESTI√ìN DE PANTALLAS / FLOW
    // ---------------------------
    const screenLogin = document.getElementById("screen-login");
    const screenProfile = document.getElementById("screen-profile");
    const screenDevice = document.getElementById("screen-device");
    const screenMain = document.getElementById("screen-main");
    const screenCommunity = document.getElementById("screen-community");

    function showScreen(id) {
      [screenLogin, screenProfile, screenDevice, screenMain, screenCommunity].forEach(
        s => s.classList.remove("active")
      );
      document.getElementById(id).classList.add("active");

      if (id === "screen-profile") {
        loadProfileFormFromStorage();
      }
      if (id === "screen-main") {
        initMainScreen();
      }
      if (id === "screen-community") {
        renderCommunitySessions();
      }
    }

    // Recuperar datos guardados
    const savedUser = JSON.parse(localStorage.getItem("thermofitUser") || "null");
    const savedDevice = localStorage.getItem("thermofitDevice");

    if (savedUser && savedDevice) {
      showScreen("screen-main");
    } else if (savedUser && !savedDevice) {
      showScreen("screen-device");
    } else {
      showScreen("screen-login");
    }

    // ---------------------------
    // LOGIN
    // ---------------------------
    const loginNameInput = document.getElementById("login-name");
    const loginEmailInput = document.getElementById("login-email");
    const btnLoginNext = document.getElementById("btn-login-next");

    btnLoginNext.addEventListener("click", () => {
      const name = loginNameInput.value.trim();
      const email = loginEmailInput.value.trim();

      if (!name || !email) {
        alert("Rellena nombre y email para continuar.");
        return;
      }

      const partialUser = { name, email };
      localStorage.setItem("thermofitUser", JSON.stringify(partialUser));
      showScreen("screen-profile");
    });

    // ---------------------------
    // PERFIL (FORM + FOTO)
    // ---------------------------
    const profileAgeInput = document.getElementById("profile-age");
    const profileWeightInput = document.getElementById("profile-weight");
    const profileGoalSelect = document.getElementById("profile-goal");
    const profilePhotoInput = document.getElementById("profile-photo");
    const profilePhotoPreview = document.getElementById("profile-photo-preview");
    const btnProfileNext = document.getElementById("btn-profile-next");
    const btnProfileBack = document.getElementById("btn-profile-back");

    let profilePhotoDataUrl = null;

    function loadProfileFormFromStorage() {
      const u = JSON.parse(localStorage.getItem("thermofitUser") || "null");
      if (!u) return;
      if (u.age) profileAgeInput.value = u.age;
      if (u.weight) profileWeightInput.value = u.weight;
      if (u.goal) profileGoalSelect.value = u.goal;
      if (u.photo) {
        profilePhotoDataUrl = u.photo;
        profilePhotoPreview.style.backgroundImage = `url(${profilePhotoDataUrl})`;
        profilePhotoPreview.classList.add("has-photo");
        profilePhotoPreview.textContent = "";
      }
    }

    profilePhotoInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        profilePhotoDataUrl = ev.target.result;
        profilePhotoPreview.style.backgroundImage = `url(${profilePhotoDataUrl})`;
        profilePhotoPreview.classList.add("has-photo");
        profilePhotoPreview.textContent = "";
      };
      reader.readAsDataURL(file);
    });

    btnProfileBack.addEventListener("click", () => {
      // Si no hay usuario guardado a√∫n, volvemos al login; si s√≠ hay, volvemos al panel
      const u = JSON.parse(localStorage.getItem("thermofitUser") || "null");
      if (u && u.email) {
        showScreen("screen-main");
      } else {
        showScreen("screen-login");
      }
    });

    btnProfileNext.addEventListener("click", () => {
      const age = profileAgeInput.value.trim();
      const weight = profileWeightInput.value.trim();
      const goal = profileGoalSelect.value;

      if (!age || !weight) {
        alert("Rellena edad y peso para continuar.");
        return;
      }

      const currentUser = JSON.parse(localStorage.getItem("thermofitUser") || "{}");
      const fullUser = { ...currentUser, age, weight, goal, photo: profilePhotoDataUrl };
      localStorage.setItem("thermofitUser", JSON.stringify(fullUser));

      showScreen("screen-device");
    });

    // ---------------------------
    // SELECCI√ìN DE CAMISETA
    // ---------------------------
    const btnDeviceBack = document.getElementById("btn-device-back");
    const deviceButtons = document.querySelectorAll(".btn-device");

    btnDeviceBack.addEventListener("click", () => {
      showScreen("screen-profile");
    });

    deviceButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const deviceId = btn.getAttribute("data-device-id");
        localStorage.setItem("thermofitDevice", deviceId);
        alert("Camiseta seleccionada: " + deviceId + ". En la versi√≥n real aqu√≠ se conectar√≠a por Bluetooth.");
        showScreen("screen-main");
        initMainScreen();
      });
    });

    // ---------------------------
    // MAIN: VARIABLES Y UI
    // ---------------------------
    const hrValueEl = document.getElementById("hr-value");
    const hrStatusEl = document.getElementById("hr-status");
    const tempMainEl = document.getElementById("temp-main");
    const tempSubEl = document.getElementById("temp-sub");
    const heatLevelTextEl = document.getElementById("heat-level-text");
    const heatDescEl = document.getElementById("heat-desc");
    const heatSliderEl = document.getElementById("heat-slider");
    const alertsContainerEl = document.getElementById("alerts-container");
    const historyListEl = document.getElementById("history-list");
    const connDot = document.getElementById("conn-dot");
    const connText = document.getElementById("conn-text");
    const chipConnection = document.getElementById("chip-connection");
    const btnConnect = document.getElementById("btn-connect");
    const modeChip = document.getElementById("mode-chip");
    const btnModeAuto = document.getElementById("btn-mode-auto");
    const btnModeManual = document.getElementById("btn-mode-manual");
    const activitySelect = document.getElementById("activity-select");
    const userSubtitle = document.getElementById("user-subtitle");
    const helloUserText = document.getElementById("hello-user-text");
    const avatarCircle = document.getElementById("avatar-circle");

    const navPanel = document.getElementById("nav-panel");
    const navCommunity = document.getElementById("nav-community");
    const navHistory = document.getElementById("nav-history");
    const navSettings = document.getElementById("nav-settings");
    const navBtns = document.querySelectorAll(".nav-btn");

    const btnCommunityBack = document.getElementById("btn-community-back");
    const communityListEl = document.getElementById("community-list");

    let connected = false;
    let mode = "AUTO";
    let heatLevel = 0;
    let fakeHr = 72;
    let fakeTempChest = 36.5;
    let fakeTempBack = 36.8;
    let fakeTempAx = 36.2;
    let totalAlerts = 0;
    let simulationStarted = false;

    function initMainScreen() {
      const user = JSON.parse(localStorage.getItem("thermofitUser") || "null");
      const device = localStorage.getItem("thermofitDevice");

      if (user && user.name) {
        helloUserText.textContent = `Hola, ${user.name} üëã`;
        if (user.goal === "rendimiento") {
          userSubtitle.textContent = "Modo rendimiento";
        } else if (user.goal === "trabajo-frio") {
          userSubtitle.textContent = "Modo trabajo en fr√≠o";
        } else {
          userSubtitle.textContent = "Modo salud y bienestar";
        }
        if (user.photo) {
          avatarCircle.style.backgroundImage = `url(${user.photo})`;
          avatarCircle.classList.add("has-photo");
        } else {
          avatarCircle.classList.remove("has-photo");
        }
      }

      if (device) {
        connText.textContent = "Listo para conectar";
      }
    }

    if (screenMain.classList.contains("active")) {
      initMainScreen();
    }

    // Conectar/desconectar (simulado)
    btnConnect.addEventListener("click", () => {
      connected = !connected;
      updateConnectionUI();
      if (connected && !simulationStarted) {
        startDemoData();
        simulationStarted = true;
      }
    });

    function updateConnectionUI() {
      if (connected) {
        connDot.classList.remove("offline");
        connText.textContent = "Conectado";
        chipConnection.style.borderColor = "rgba(34, 197, 94, 0.4)";
      } else {
        connDot.classList.add("offline");
        connText.textContent = "Sin conectar";
        chipConnection.style.borderColor = "var(--border)";
      }
    }

    // Modo Auto / Manual
    btnModeAuto.addEventListener("click", () => {
      mode = "AUTO";
      btnModeAuto.classList.add("active");
      btnModeManual.classList.remove("active");
      modeChip.innerHTML = '<span class="chip-dot"></span> Modo autom√°tico';
      updateHeatDescription();
    });

    btnModeManual.addEventListener("click", () => {
      mode = "MANUAL";
      btnModeManual.classList.add("active");
      btnModeAuto.classList.remove("active");
      modeChip.innerHTML = '<span class="chip-dot"></span> Modo manual';
      updateHeatFromSlider();
    });

    heatSliderEl.addEventListener("input", () => {
      if (mode === "MANUAL") {
        updateHeatFromSlider();
      }
    });

    function updateHeatFromSlider() {
      heatLevel = parseInt(heatSliderEl.value, 10);
      heatLevelTextEl.textContent = heatLevel + "%";
      if (heatLevel === 0) {
        heatDescEl.textContent = "Calefacci√≥n desactivada";
      } else if (heatLevel <= 30) {
        heatDescEl.textContent = "Calor suave";
      } else if (heatLevel <= 70) {
        heatDescEl.textContent = "Calor moderado";
      } else {
        heatDescEl.textContent = "Alto nivel de calefacci√≥n";
      }
    }

    function updateHeatDescription() {
      if (mode === "AUTO") {
        heatDescEl.textContent = "La camiseta ajusta el calor seg√∫n tu temperatura y actividad";
      } else {
        updateHeatFromSlider();
      }
    }

    // Selector de actividad
    activitySelect.addEventListener("change", () => {
      console.log("Actividad actual:", activitySelect.value);
    });

    // Simulaci√≥n de datos (demo)
    function startDemoData() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });
      historyListEl.innerHTML = `
        <div class="history-item">
          <span>Inicio sesi√≥n</span>
          <span>${timeStr}</span>
        </div>
        <div class="history-item">
          <span>Nivel medio calor</span>
          <span>0%</span>
        </div>
        <div class="history-item">
          <span>Alertas</span>
          <span>0</span>
        </div>
      `;

      updateHeatDescription();

      setInterval(() => {
        if (!connected) return;

        fakeHr += (Math.random() - 0.5) * 2;
        fakeTempChest += (Math.random() - 0.5) * 0.05;
        fakeTempBack += (Math.random() - 0.5) * 0.05;
        fakeTempAx += (Math.random() - 0.5) * 0.05;

        let hr = Math.round(fakeHr);
        const tChest = fakeTempChest;
        const tBack = fakeTempBack;
        const tAx = fakeTempAx;
        const tMean = (tChest + tBack + tAx) / 3;

        const activity = activitySelect.value;
        let hrLow = 55;
        let hrHigh = 100;
        if (activity === "deporte") {
          hrHigh = 150;
        } else if (activity === "trabajo-frio") {
          hrLow = 50;
          hrHigh = 110;
        }

        hrValueEl.textContent = hr;
        tempMainEl.textContent = tMean.toFixed(1);
        tempSubEl.textContent =
          `Pecho: ${tChest.toFixed(1)}¬∞C ¬∑ Espalda: ${tBack.toFixed(1)}¬∞C ¬∑ Axila: ${tAx.toFixed(1)}¬∞C`;

        if (hr < hrLow) {
          hrStatusEl.textContent = "FC baja para la actividad seleccionada";
        } else if (hr <= hrHigh) {
          hrStatusEl.textContent = "Rango acorde a la actividad";
        } else {
          hrStatusEl.textContent = "FC elevada: considera bajar el ritmo";
          pushAlert("Frecuencia card√≠aca elevada", "Revisa tu esfuerzo y respira profundo.");
        }

        if (mode === "AUTO") {
          if (activity === "trabajo-frio") {
            if (tMean < 36.5) heatLevel = 70;
            else if (tMean > 37.8) heatLevel = 10;
            else heatLevel = 40;
          } else if (activity === "deporte") {
            if (tMean < 36.0) heatLevel = 40;
            else if (tMean > 37.5) heatLevel = 0;
            else heatLevel = 20;
          } else {
            if (tMean < 36.0) heatLevel = 60;
            else if (tMean > 37.5) heatLevel = 10;
            else heatLevel = 30;
          }
          heatSliderEl.value = heatLevel;
          heatLevelTextEl.textContent = heatLevel + "%";
          updateHeatDescription();
        }

        if (tMean > 38.0) {
          pushAlert("Temperatura elevada", "Posible sobrecalentamiento, hidr√°tate y descansa.");
        } else if (tMean < 35.5) {
          pushAlert("Temperatura baja", "Podr√≠as estar perdiendo demasiado calor.");
        }

        historyListEl.innerHTML = `
          <div class="history-item">
            <span>Inicio sesi√≥n</span>
            <span>${timeStr}</span>
          </div>
          <div class="history-item">
            <span>Nivel medio calor (aprox)</span>
            <span>${heatLevel}%</span>
          </div>
          <div class="history-item">
            <span>Alertas</span>
            <span>${totalAlerts}</span>
          </div>
        `;
      }, 2000);
    }

    function pushAlert(title, desc) {
      totalAlerts++;
      alertsContainerEl.innerHTML = `
        <div class="alert-item">
          <div class="alert-title">${title}</div>
          <div class="metric-sub">${desc}</div>
        </div>
        <div class="alert-tag" style="margin-top:8px;">
          <span class="alert-tag-dot"></span>
          √öltima alerta hace unos segundos
        </div>
      `;
    }

    // ---------------------------
    // SESIONES DE LA COMUNIDAD
    // ---------------------------
    const communitySessions = [
      {
        user: "Laura",
        goal: "Rendimiento deportivo",
        activity: "Carrera nocturna",
        duration: "42 min",
        avgHR: 138,
        temp: "37.2 ¬∞C",
        note: "Entreno de running a 8¬∫C con modo auto al 40%.",
        timeAgo: "hace 2 h"
      },
      {
        user: "Carlos",
        goal: "Trabajo en fr√≠o",
        activity: "Almac√©n refrigerado",
        duration: "3 h",
        avgHR: 96,
        temp: "36.6 ¬∞C",
        note: "Trabajo a 4¬∫C con modo trabajo en fr√≠o.",
        timeAgo: "hace 5 h"
      },
      {
        user: "Ana",
        goal: "Salud y bienestar",
        activity: "Paseo suave",
        duration: "25 min",
        avgHR: 112,
        temp: "36.9 ¬∞C",
        note: "Paseo por la tarde, la camiseta solo dio calor suave.",
        timeAgo: "ayer"
      }
    ];

    function renderCommunitySessions() {
      communityListEl.innerHTML = communitySessions
        .map(s => {
          const initial = s.user[0].toUpperCase();
          return `
          <div class="community-card">
            <div class="community-avatar">${initial}</div>
            <div class="community-meta">
              <div class="community-header">
                <strong>${s.user}</strong>
                <span class="tag">${s.timeAgo}</span>
              </div>
              <div class="community-main">
                <div><strong>${s.activity}</strong> ¬∑ ${s.duration}</div>
                <div>HR media: ${s.avgHR} bpm ¬∑ Temp: ${s.temp}</div>
                <div>${s.note}</div>
              </div>
            </div>
          </div>
        `;
        })
        .join("");
    }

    btnCommunityBack.addEventListener("click", () => {
      setActiveNav(navPanel);
      showScreen("screen-main");
    });

    // ---------------------------
    // NAV BOTTOM
    // ---------------------------
    function setActiveNav(btn) {
      navBtns.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    }

    navPanel.addEventListener("click", () => {
      setActiveNav(navPanel);
      showScreen("screen-main");
    });

    navCommunity.addEventListener("click", () => {
      setActiveNav(navCommunity);
      showScreen("screen-community");
    });

    navHistory.addEventListener("click", () => {
      // De momento solo hacemos scroll al historial de hoy dentro del panel
      setActiveNav(navPanel);
      showScreen("screen-main");
      document.getElementById("history-list").scrollIntoView({ behavior: "smooth" });
    });

    navSettings.addEventListener("click", () => {
      // Abrimos el formulario de perfil como ajustes
      setActiveNav(navSettings);
      showScreen("screen-profile");
    });

    // ---------------------------
    // SERVICE WORKER (PWA)
    // ---------------------------
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./service-worker.js")
          .catch((err) => console.log("SW error", err));
      });
    }
  </script>
</body>
</html>
